---
import { siteConfig } from "../data/site.ts";
import BaseLayout from "../layouts/BaseLayout.astro";
import { parseLocalDate } from "../utils/date.ts";
import { toRoman } from "../utils/formatting.ts";

interface Post {
  url: string;
  frontmatter: {
    title: string;
    subtitle?: string;
    date: string;
    bskyPostCid?: string;
    math?: boolean;
    preview?: boolean;
    description?: string;
    series?: {
      name: string;
      part: number;
    };
  };
}

function getDisplayTitle(post: Post): string {
  if (post.frontmatter.series) {
    const seriesName = post.frontmatter.series.name;
    const romanPart = toRoman(post.frontmatter.series.part);
    return `${seriesName} ${romanPart}`;
  }
  return post.frontmatter.title;
}

function getDisplaySubtitle(post: Post): string | undefined {
  if (post.frontmatter.series) {
    return post.frontmatter.title;
  }
  return post.frontmatter.subtitle;
}


// Get all posts and sort by date (newest first)
const allPosts = Object.values(
  import.meta.glob("./posts/*.mdx", { eager: true }),
) as Post[];
const sortedPosts = allPosts
  .filter((post) => (import.meta.env.PROD ? !post.frontmatter.preview : true))
  .sort(
    (a, b) =>
      parseLocalDate(b.frontmatter.date).getTime() -
      parseLocalDate(a.frontmatter.date).getTime(),
  );
---

<BaseLayout title={siteConfig.title} , url={siteConfig.baseUrl}>
  <h1>All Posts</h1>

  <section class="posts-list">
    <ul class="post-list">
      {
        sortedPosts.map((post) => (
          <li>
            <article class="post-preview">
              <h3>
                <a href={post.url + '/'} class="post-link">
                  {getDisplayTitle(post)}
                </a>
                {getDisplaySubtitle(post) &&
                  <p>{getDisplaySubtitle(post)}</p>
                }
              </h3>
              <time class="post-meta" datetime={post.frontmatter.date}>
                {parseLocalDate(post.frontmatter.date).toLocaleDateString(
                  "en-US",
                  {
                    year: "numeric",
                    month: "long",
                    day: "numeric",
                  },
                )}
              </time>
              {post.frontmatter.description && (
                <p class="post-description">{post.frontmatter.description}</p>
              )}
            </article>
          </li>
        ))
      }
    </ul>
  </section>
</BaseLayout>
